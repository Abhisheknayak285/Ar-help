<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ar Help - AI Chat</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f8; /* Light background, similar to ChatGPT */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0; /* Remove body padding for full width chat */
            box-sizing: border-box;
            transition: background-color 0.3s ease;
        }
        #chat-container {
            background-color: #ffffff;
            border-radius: 0.75rem; /* Slightly less rounded for a sleek look */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05); /* Subtle shadow */
            width: 100%;
            max-width: 800px; /* Wider chat area */
            height: 95vh; /* Take up more vertical space */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        #chat-header {
            background-color: #ffffff;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between; /* Ensures space between title and icon */
            align-items: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            position: relative; /* Crucial for dropdown positioning */
            transition: background-color 0.3s ease, border-bottom-color 0.3s ease, color 0.3s ease;
        }
        #messages-container {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scroll-behavior: smooth;
            background-color: #f7f7f8; /* Message background */
            transition: background-color 0.3s ease;
        }
        .message {
            max-width: 90%; /* Wider messages */
            padding: 0.8rem 1.2rem;
            border-radius: 0.75rem; /* Consistent rounding */
            line-height: 1.6;
            word-wrap: break-word;
            box-shadow: none; /* Remove individual message shadows */
        }
        .user-message {
            background-color: #ffffff; /* White background for user messages */
            align-self: flex-end;
            color: #333;
            border: 1px solid #e0e0e0; /* Subtle border for user message */
        }
        .ai-message {
            background-color: #e6e6e6; /* Light gray background for AI messages */
            align-self: flex-start;
            color: #333;
        }
        .message-timestamp {
            font-size: 0.65rem; /* Smaller timestamp */
            color: #888;
            margin-top: 0.3rem;
            text-align: right;
            opacity: 0.9;
        }
        .ai-message .message-timestamp {
            text-align: left;
        }
        #input-area {
            display: flex;
            flex-direction: column; /* Stack input and file preview */
            align-items: center; /* Center horizontally */
            padding: 1rem 1.5rem;
            border-top: 1px solid #e0e0e0;
            background-color: #ffffff;
            transition: background-color 0.3s ease, border-top-color 0.3s ease;
        }
        .input-wrapper {
            display: flex;
            width: 100%;
            max-width: 700px; /* Max width for input to match ChatGPT */
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }
        #user-input {
            flex-grow: 1;
            padding: 0.75rem 1.25rem;
            border: none; /* No individual border */
            outline: none;
            font-size: 1rem;
            background-color: transparent; /* Transparent background */
            color: #333;
            transition: color 0.3s ease;
        }
        #user-input::placeholder {
            color: #999;
        }
        #user-input:focus {
            box-shadow: none; /* Remove glow on focus, handled by wrapper */
        }
        .input-wrapper:focus-within {
            border-color: #888; /* Darker border on focus */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        #send-button {
            background-color: transparent; /* Transparent button */
            color: #666; /* Gray icon color */
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            border: none;
            cursor: pointer;
            font-size: 1.2rem; /* Larger icon size */
            font-weight: 600;
            transition: color 0.2s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #send-button:hover {
            color: #333; /* Darker on hover */
            background-color: #f0f0f0; /* Subtle background on hover */
        }
        #send-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        #loading-indicator {
            display: none;
            text-align: center;
            padding: 0.5rem 1rem; /* Smaller padding */
            color: #6b7280;
            font-style: italic;
            font-size: 0.9rem; /* Smaller font size */
            animation: pulse 1.5s infinite ease-in-out;
            background-color: #f7f7f8; /* Match message container */
            transition: background-color 0.3s ease;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        /* Simple modal for alerts */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #ccc;
            width: 85%;
            max-width: 450px;
            border-radius: 1rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            text-align: center;
            animation: fadeIn 0.3s ease-out;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .close-button {
            color: #9e9e9e;
            float: right;
            font-size: 32px;
            font-weight: bold;
            line-height: 1;
            margin-top: -10px;
            margin-right: -10px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #modal-ok-button {
            background-color: #42a5f5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s, transform 0.1s;
        }
        #modal-ok-button:hover {
            background-color: #2196f3;
            transform: translateY(-1px);
        }

        /* Hamburger Menu Styles */
        #dropdown-menu {
            transform-origin: top right;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
            background-color: #ffffff; /* White background for dropdown */
            border: 1px solid #e0e0e0;
            position: absolute; /* Keep absolute for dropdown */
            right: 1.5rem; /* Align with header padding */
            top: 100%; /* Position below the header */
            min-width: 180px; /* Ensure sufficient width */
            border-radius: 0.5rem; /* Slightly rounded corners for dropdown */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Subtle shadow for dropdown */
        }
        #dropdown-menu.show {
            transform: scale(1);
            opacity: 1;
            display: block;
        }
        #dropdown-menu.hide {
            transform: scale(0.95);
            opacity: 0;
            display: none;
        }
        /* Unified styling for all top-level menu items */
        #dropdown-menu .menu-item {
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem; /* Consistent font size */
            color: #333; /* Default text color for light mode */
            transition: background-color 0.15s ease, color 0.15s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* Indicate clickable */
        }
        #dropdown-menu .menu-item:hover {
            background-color: #f0f0f0;
        }
        /* Specific styles for collapsible content */
        .collapsible-content {
            max-height: 0; /* Ensures content is initially hidden */
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            font-size: 0.85rem; /* Smaller content font */
            padding-left: 2.5rem; /* Deeper indent for content */
            color: #666; /* Default text color for light mode content */
            line-height: 1.4; /* Improved line spacing */
        }
        .collapsible-content.expanded {
            padding-top: 0.1rem; /* Add padding when expanded */
            padding-bottom: 0.1rem; /* Add padding when expanded */
        }
        .arrow-icon {
            transition: transform 0.2s ease-out;
        }
        .collapsible-header.expanded .arrow-icon {
            transform: rotate(90deg);
        }

        /* Hamburger Icon Styling */
        #hamburger-menu-icon .line {
            width: 24px; /* Fixed width */
            height: 2.5px; /* Thinner lines */
            background-color: #333; /* Black lines in light mode */
            margin-bottom: 4px; /* Spacing between lines */
            border-radius: 1px; /* Slightly rounded ends */
            transition: background-color 0.3s ease;
        }
        #hamburger-menu-icon .line:last-child {
            margin-bottom: 0; /* No margin after the last line */
        }
        /* Ensure lines are white in dark mode */
        body.dark-mode #hamburger-menu-icon .line {
            background-color: #ffffff; /* White lines in dark mode */
        }
        #hamburger-menu-icon:hover .line {
            /* No change on hover for color, only background of the icon container */
        }

        /* File Upload Styling */
        #file-upload-section {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 700px;
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: #f0f0f0;
            border-radius: 0.5rem;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #333;
            display: none; /* Hidden by default */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #file-name {
            flex-grow: 1;
            margin-right: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #clear-file-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 0.2rem;
            transition: color 0.2s;
        }
        #clear-file-btn:hover {
            color: #333;
        }
        .file-upload-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0.75rem 0.5rem; /* Smaller padding for icon button */
            color: #666;
            font-size: 1.2rem;
            transition: color 0.2s, background-color 0.2s;
            border-radius: 1.5rem; /* Match input wrapper radius */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .file-upload-btn:hover {
            color: #333;
            background-color: #f0f0f0;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #202123; /* Dark background */
            color: #e0e0e0;
        }

        body.dark-mode #chat-container {
            background-color: #343541;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode #chat-header {
            background-color: #343541;
            border-bottom-color: #444654;
            color: #e0e0e0;
        }

        body.dark-mode #messages-container {
            background-color: #444654;
        }

        body.dark-mode .user-message {
            background-color: #343541; /* Darker background for user messages */
            color: #e0e0e0;
            border-color: #444654;
        }

        body.dark-mode .ai-message {
            background-color: #444654; /* Darker background for AI messages */
            color: #e0e0e0;
        }

        body.dark-mode .message-timestamp {
            color: #b0b0b0;
        }

        body.dark-mode #input-area {
            background-color: #343541;
            border-top-color: #444654;
        }

        body.dark-mode .input-wrapper {
            background-color: #40414f;
            border-color: #555666;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .input-wrapper:focus-within {
            border-color: #666;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode #user-input {
            background-color: transparent;
            color: #e0e0e0;
        }

        body.dark-mode #user-input::placeholder {
            color: #b0b0b0;
        }

        body.dark-mode #send-button {
            color: #b0b0b0;
        }
        body.dark-mode #send-button:hover {
            color: #e0e0e0;
            background-color: #555666;
        }

        body.dark-mode #loading-indicator {
            background-color: #444654;
            color: #b0b0b0;
        }

        body.dark-mode .modal-content {
            background-color: #40414f;
            color: #e0e0e0;
            border: 1px solid #555666;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
        }

        body.dark-mode .close-button {
            color: #b0b0b0;
        }
        body.dark-mode .close-button:hover {
            color: #e0e0e0;
        }
        body.dark-mode #modal-ok-button {
            background-color: #64b5f6;
        }
        body.dark-mode #modal-ok-button:hover {
            background-color: #42a5f5;
        }

        body.dark-mode #dropdown-menu {
            background-color: #343541;
            border-color: #444654;
        }
        body.dark-mode #dropdown-menu .menu-item { /* Apply dark mode to unified menu-item class */
            color: #e0e0e0;
        }
        body.dark-mode #dropdown-menu .menu-item:hover {
            background-color: #444654;
        }
        body.dark-mode #dropdown-menu .collapsible-header span { /* Specific for header text */
            color: #e0e0e0;
        }
        body.dark-mode #dropdown-menu .collapsible-header:hover {
            background-color: #444654;
        }
        body.dark-mode #dropdown-menu .collapsible-content {
            color: #b0b0b0;
        }
        body.dark-mode .collapsible-header .arrow-icon {
            color: #b0b0b0;
        }

        /* Dark mode for file upload section */
        body.dark-mode #file-upload-section {
            background-color: #40414f;
            color: #e0e0e0;
        }
        body.dark-mode #clear-file-btn {
            color: #b0b0b0;
        }
        body.dark-mode #clear-file-btn:hover {
            color: #e0e0e0;
        }
        body.dark-mode .file-upload-btn {
            color: #b0b0b0;
        }
        body.dark-mode .file-upload-btn:hover {
            color: #e0e0e0;
            background-color: #555666;
        }
    </style>
</head>
<body>

    <div id="chat-container">
        <div id="chat-header">
            <div class="flex-grow text-center">Ar Help</div>
            <div id="hamburger-menu-icon" class="cursor-pointer p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200 z-50">
                <div class="line"></div>
                <div class="line"></div>
                <div class="line"></div>
            </div>
            <div id="dropdown-menu" class="absolute top-full right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-2 z-40 hidden origin-top-right transform scale-95 opacity-0 transition-all duration-200 ease-out">
                <a href="#" class="menu-item" id="new-chat-btn">New Chat</a>
                <a href="#" class="menu-item" id="summarize-chat-btn">Summarize Chat ✨</a>

                <!-- About Section -->
                <div class="menu-item collapsible-header" data-target="about-content">
                    <span class="font-semibold">About</span>
                    <svg class="arrow-icon w-4 h-4 text-gray-600 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </div>
                <div id="about-content" class="collapsible-content">
                    Developed by Abhishek Nayak
                </div>

                <!-- Help & Support Section -->
                <div class="menu-item collapsible-header" data-target="help-support-content">
                    <span class="font-semibold">Help & Support</span>
                    <svg class="arrow-icon w-4 h-4 text-gray-600 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </div>
                <div id="help-support-content" class="collapsible-content">
                    Email: abhi24@gmail.com
                </div>

                <!-- Theme Section -->
                <div class="menu-item">
                    <span class="font-semibold">Theme</span>
                    <label class="switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
        </div>
        <div id="messages-container">
            <!-- Chat messages will be appended here -->
            <!-- Initial greeting message will be dynamically added by JS -->
        </div>
        <div id="loading-indicator">Ar Help is typing...</div>
        <div id="input-area">
            <div class="input-wrapper">
                <input type="file" id="file-input" accept="image/*" class="hidden">
                <label for="file-input" class="file-upload-btn">
                    <!-- Paperclip icon for file upload -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-paperclip"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.2"/></svg>
                </label>
                <input type="text" id="user-input" placeholder="Message Ar Help...">
                <button id="send-button">
                    <!-- Send icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4 20-7Z"/><path d="M15 7L6 16"/></svg>
                </button>
            </div>
            <div id="file-upload-section">
                <span id="file-name"></span>
                <button id="clear-file-btn">&times;</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message"></p>
            <button id="modal-ok-button" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">OK</button>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const hamburgerIcon = document.getElementById('hamburger-menu-icon');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const newChatBtn = document.getElementById('new-chat-btn');
        const summarizeChatBtn = document.getElementById('summarize-chat-btn');
        const themeToggle = document.getElementById('theme-toggle');

        // File upload elements
        const fileInput = document.getElementById('file-input');
        const fileUploadSection = document.getElementById('file-upload-section');
        const fileNameSpan = document.getElementById('file-name');
        const clearFileBtn = document.getElementById('clear-file-btn');
        let selectedFile = null; // To store the selected file object

        // Custom Modal Elements
        const modal = document.getElementById('myModal');
        const modalMessage = document.getElementById('modal-message');
        const closeButton = document.querySelector('.close-button');
        const modalOkButton = document.getElementById('modal-ok-button');

        // Function to show custom modal
        function showModal(message) {
            modalMessage.textContent = message;
            modal.style.display = 'flex'; // Use flex to center
        }

        // Close modal when close button or OK button is clicked
        closeButton.onclick = function() {
            modal.style.display = 'none';
        }
        modalOkButton.onclick = function() {
            modal.style.display = 'none';
        }
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Perplexity API configuration
        const PERPLEXITY_API_KEY = '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'; // User provided API key
        const PERPLEXITY_API_URL = 'https://api.perplexity.ai/chat/completions';
        const PERPLEXITY_MODEL = 'sonar-pro'; // Using 'sonar-pro' as a widely available model

        // Gemini API configuration (for summarization and multimodal chat)
        const GEMINI_API_KEY = ""; // Canvas will provide this if empty
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        // Function to get current time in HH:MM format
        function getCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Function to append a message to the chat
        function appendMessage(sender, text, imageUrl = null) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            
            let contentHtml = text;
            if (imageUrl) {
                contentHtml += `<br><img src="${imageUrl}" alt="Uploaded Image" class="mt-2 rounded-md max-w-full h-auto" style="max-height: 200px; object-fit: contain;">`;
            }

            messageElement.innerHTML = `
                ${contentHtml}
                <div class="message-timestamp">${sender === 'user' ? 'You' : 'AI'} - <span class="timestamp-value">${getCurrentTime()}</span></div>
            `;
            messagesContainer.appendChild(messageElement);
            // Scroll to the bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Function to send message to AI (Perplexity or Gemini based on content)
        async function sendMessage() {
            const messageText = userInput.value.trim();

            if (messageText === '' && !selectedFile) {
                showModal('Please enter a message or select a file.');
                return;
            }

            // Display user message immediately
            if (selectedFile && selectedFile.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appendMessage('user', messageText || 'Image uploaded.', e.target.result);
                };
                reader.readAsDataURL(selectedFile);
            } else if (selectedFile) {
                // For non-image files, just show the file name in the chat
                appendMessage('user', `${messageText || 'File uploaded.'} (File: ${selectedFile.name})`);
            } else {
                appendMessage('user', messageText);
            }

            userInput.value = ''; // Clear input immediately
            loadingIndicator.style.display = 'block'; // Show loading indicator
            sendButton.disabled = true; // Disable send button
            userInput.disabled = true; // Disable input field
            fileInput.disabled = true; // Disable file input
            clearFileBtn.disabled = true; // Disable clear file button

            let aiResponseText = '';

            try {
                if (selectedFile && selectedFile.type.startsWith('image/')) {
                    // Send to Gemini for multimodal
                    let parts = [];
                    if (messageText) {
                        parts.push({ text: messageText });
                    }
                    const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]); // Get base64 part
                        reader.onerror = reject;
                        reader.readAsDataURL(selectedFile);
                    });
                    parts.push({
                        inlineData: {
                            mimeType: selectedFile.type,
                            data: base64Data
                        }
                    });

                    const geminiPayload = { contents: [{ role: "user", parts: parts }] };
                    const geminiResponse = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiPayload)
                    });
                    const geminiResult = await geminiResponse.json();

                    if (geminiResult.candidates && geminiResult.candidates.length > 0 &&
                        geminiResult.candidates[0].content && geminiResult.candidates[0].content.parts &&
                        geminiResult.candidates[0].content.parts.length > 0) {
                        aiResponseText = geminiResult.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('No response from Gemini AI.');
                    }

                } else if (selectedFile) {
                    // Non-image file selected, but cannot be processed by AI directly
                    showModal('Only image files can be processed directly by the AI. Other file types will be ignored for AI processing.');
                    aiResponseText = 'I received your file, but I can only process image files directly. Please ask your question in text or upload an image.';
                } else {
                    // Send to Perplexity for text-only
                    const perplexityPayload = {
                        model: PERPLEXITY_MODEL,
                        messages: [
                            { role: "system", content: "You are Ar Help, a helpful AI assistant. Provide extremely concise, direct, and conversational answers. Do NOT use any markdown, bullet points, lists, bolding, italics, or any other special formatting. Provide plain text answers only. Do NOT include any citations, footnotes, numerical references like [1], [2], or any verbose formatting such as 'Day of the week:', 'Day of the year:', 'ISO (YYYY-MM-DD):', 'MM-DD-YYYY:', 'DD-MM-YYYY:', or 'YYYY-MM-DD:'. Answer only the core question directly and briefly. If asked for the current date, provide only the date in a simple format like 'Today is July 19, 2025.'. If asked for code, provide only the code block without any additional explanation or formatting outside the code block itself. For example, if asked for HTML, respond with ```html\n<!-- your html code -->\n```." },
                            { role: "user", content: messageText }
                        ],
                        stream: false
                    };

                    const perplexityResponse = await fetch(PERPLEXITY_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${PERPLEXITY_API_KEY}`
                        },
                        body: JSON.stringify(perplexityPayload)
                    });

                    if (!perplexityResponse.ok) {
                        const errorData = await perplexityResponse.json();
                        throw new Error(`Perplexity API error: ${perplexityResponse.status} - ${errorData.error.message || perplexityResponse.statusText}`);
                    }

                    const perplexityResult = await perplexityResponse.json();
                    aiResponseText = perplexityResult.choices[0]?.message?.content || 'No response from AI.';
                }
                
                appendMessage('ai', aiResponseText);

            } catch (error) {
                console.error('Error fetching from AI API:', error);
                appendMessage('ai', 'Oops! Something went wrong. Please try again later. (Error: ' + error.message + ')');
            } finally {
                resetInputState();
            }
        }

        // Function to reset input area state
        function resetInputState() {
            loadingIndicator.style.display = 'none'; // Hide loading indicator
            sendButton.disabled = false; // Enable send button
            userInput.disabled = false; // Enable input field
            fileInput.disabled = false; // Enable file input
            clearFileBtn.disabled = false; // Enable clear file button
            selectedFile = null; // Clear selected file
            fileUploadSection.style.display = 'none'; // Hide file section
            fileNameSpan.textContent = ''; // Clear file name
            userInput.focus(); // Focus input for next message
        }

        // Function to summarize chat using Gemini API
        async function summarizeChat() {
            // Close dropdown menu immediately
            dropdownMenu.classList.remove('show');
            dropdownMenu.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                dropdownMenu.classList.add('hidden');
            }, 200);

            let conversationHistory = [];
            const messages = messagesContainer.querySelectorAll('.message');
            messages.forEach(msg => {
                const sender = msg.classList.contains('user-message') ? 'You' : 'AI';
                // Extract text, ignore images for summarization prompt
                const textContent = msg.querySelector('br') ? msg.firstChild.textContent.trim() : msg.textContent.split('\n')[0].trim();
                conversationHistory.push(`${sender}: ${textContent}`);
            });

            if (conversationHistory.length <= 1) { // Only initial greeting + 0 or 1 user message
                showModal('Please have more conversation to summarize.');
                return;
            }

            const prompt = `Please summarize the following conversation concisely:\n\n${conversationHistory.join('\n')}`;

            loadingIndicator.textContent = 'Ar Help is summarizing...';
            loadingIndicator.style.display = 'block';
            sendButton.disabled = true;
            userInput.disabled = true;
            fileInput.disabled = true;
            clearFileBtn.disabled = true;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = GEMINI_API_KEY; // Canvas will provide this
                const apiUrl = GEMINI_API_URL;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const summaryText = result.candidates[0].content.parts[0].text;
                    appendMessage('ai', `✨ Summary: ${summaryText}`);
                } else {
                    throw new Error('No summary generated by Gemini API.');
                }
            } catch (error) {
                console.error('Error summarizing chat with Gemini API:', error);
                appendMessage('ai', 'Oops! Could not summarize the chat. (Error: ' + error.message + ')');
            } finally {
                resetInputState();
                loadingIndicator.textContent = 'Ar Help is typing...'; // Reset text
            }
        }


        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // Hamburger menu toggle
        hamburgerIcon.addEventListener('click', () => {
            if (dropdownMenu.classList.contains('hidden')) {
                dropdownMenu.classList.remove('hidden', 'opacity-0', 'scale-95');
                dropdownMenu.classList.add('show');
            } else {
                dropdownMenu.classList.remove('show');
                dropdownMenu.classList.add('opacity-0', 'scale-95');
                // Use a timeout to allow transition to complete before hiding
                setTimeout(() => {
                    dropdownMenu.classList.add('hidden');
                }, 200);
            }
        });

        // Close dropdown if clicked outside
        document.addEventListener('click', (event) => {
            if (!dropdownMenu.contains(event.target) && !hamburgerIcon.contains(event.target)) {
                if (dropdownMenu.classList.contains('show')) {
                    dropdownMenu.classList.remove('show');
                    dropdownMenu.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        dropdownMenu.classList.add('hidden');
                    }, 200);
                }
            }
        });

        // New Chat functionality
        newChatBtn.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent default link behavior
            messagesContainer.innerHTML = ''; // Clear all messages
            appendMessage('ai', 'Hello! This is Ar Help Developed By Abhishek Nayak. Need Any Help ?');
            // Close the menu after clicking
            dropdownMenu.classList.remove('show');
            dropdownMenu.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                dropdownMenu.classList.add('hidden');
            }, 200);
            resetInputState(); // Also reset file input state
        });

        // Summarize Chat functionality
        summarizeChatBtn.addEventListener('click', (event) => {
            event.preventDefault();
            summarizeChat();
        });


        // Theme Toggle functionality
        function applyTheme(isDarkMode) {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        themeToggle.addEventListener('change', () => {
            const isDarkMode = themeToggle.checked;
            applyTheme(isDarkMode);
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });

        // Load theme and initial greeting on page load
        window.addEventListener('load', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                themeToggle.checked = true;
                applyTheme(true);
            } else {
                themeToggle.checked = false;
                applyTheme(false);
            }
            // Append the initial greeting message
            appendMessage('ai', 'Hello! This is Ar Help Developed By Abhishek Nayak. Need Any Help ?');
        });

        // Accordion functionality for About and Help & Support
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const targetId = header.dataset.target;
                const content = document.getElementById(targetId);
                
                // Close any other open accordion content
                document.querySelectorAll('.collapsible-content.expanded').forEach(openContent => {
                    if (openContent.id !== targetId) {
                        openContent.classList.remove('expanded');
                        openContent.style.maxHeight = "0";
                        openContent.previousElementSibling.classList.remove('expanded'); // Remove expanded from header
                    }
                });

                // Toggle 'expanded' class on header and content
                header.classList.toggle('expanded');
                content.classList.toggle('expanded');

                // Adjust max-height for smooth transition
                if (content.classList.contains('expanded')) {
                    content.style.maxHeight = content.scrollHeight + "px";
                } else {
                    content.style.maxHeight = "0";
                }
            });
        });

        // File input change event listener
        fileInput.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                const file = event.target.files[0];
                if (file.type.startsWith('image/')) {
                    selectedFile = file;
                    fileNameSpan.textContent = selectedFile.name;
                    fileUploadSection.style.display = 'flex'; // Show file section
                } else {
                    showModal('Only image files are supported for direct AI processing. Please select an image.');
                    fileInput.value = ''; // Clear the file input
                    selectedFile = null;
                    fileUploadSection.style.display = 'none';
                }
            } else {
                selectedFile = null;
                fileUploadSection.style.display = 'none';
                fileNameSpan.textContent = '';
            }
        });

        // Clear file button event listener
        clearFileBtn.addEventListener('click', () => {
            fileInput.value = ''; // Clear the file input
            selectedFile = null;
            fileUploadSection.style.display = 'none';
            fileNameSpan.textContent = '';
        });

    </script>
</body>
</html>
